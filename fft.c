#include "fft.h"

static const int16_t sinTable[N_WAVE] = {
    0,    402,    803,   1205,   1605,   2005,   2403,   2800,
    3196,   3589,   3980,   4369,   4755,   5139,   5519,   5896,
    6269,   6639,   7004,   7365,   7722,   8075,   8422,   8764,
    9101,   9433,   9759,  10079,  10393,  10700,  11002,  11296,
    11584,  11865,  12139,  12405,  12664,  12915,  13158,  13394,
    13621,  13841,  14052,  14254,  14448,  14633,  14810,  14977,
    15135,  15285,  15425,  15556,  15677,  15789,  15892,  15984,
    16068,  16141,  16205,  16259,  16304,  16338,  16363,  16378,
    16383,  16378,  16363,  16338,  16304,  16259,  16205,  16141,
    16068,  15984,  15892,  15789,  15677,  15556,  15425,  15285,
    15135,  14977,  14810,  14633,  14448,  14254,  14052,  13841,
    13621,  13394,  13158,  12915,  12664,  12405,  12139,  11865,
    11584,  11296,  11002,  10700,  10393,  10079,   9759,   9433,
    9101,   8764,   8422,   8075,   7722,   7365,   7004,   6639,
    6269,   5896,   5519,   5139,   4755,   4369,   3980,   3589,
    3196,   2800,   2403,   2005,   1605,   1205,    803,    402,
    0,   -402,   -803,  -1205,  -1605,  -2005,  -2403,  -2800,
    -3196,  -3589,  -3980,  -4369,  -4755,  -5139,  -5519,  -5896,
    -6269,  -6639,  -7004,  -7365,  -7722,  -8075,  -8422,  -8764,
    -9101,  -9433,  -9759, -10079, -10393, -10700, -11002, -11296,
    -11584, -11865, -12139, -12405, -12664, -12915, -13158, -13394,
    -13621, -13841, -14052, -14254, -14448, -14633, -14810, -14977,
    -15135, -15285, -15425, -15556, -15677, -15789, -15892, -15984,
    -16068, -16141, -16205, -16259, -16304, -16338, -16363, -16378,
    -16383, -16378, -16363, -16338, -16304, -16259, -16205, -16141,
    -16068, -15984, -15892, -15789, -15677, -15556, -15425, -15285,
    -15135, -14977, -14810, -14633, -14448, -14254, -14052, -13841,
    -13621, -13394, -13158, -12915, -12664, -12405, -12139, -11865,
    -11584, -11296, -11002, -10700, -10393, -10079,  -9759,  -9433,
    -9101,  -8764,  -8422,  -8075,  -7722,  -7365,  -7004,  -6639,
    -6269,  -5896,  -5519,  -5139,  -4755,  -4369,  -3980,  -3589,
    -3196,  -2800,  -2403,  -2005,  -1605,  -1205,   -803,   -402,
};

static const uint16_t hammingWindow[FFT_SIZE] = {
    314,    314,    316,    319,    323,    328,    334,    342,
    350,    360,    371,    383,    396,    410,    425,    441,
    459,    477,    497,    517,    539,    561,    585,    609,
    635,    661,    689,    717,    746,    776,    807,    839,
    871,    905,    939,    974,   1010,   1046,   1084,   1121,
    1160,   1199,   1239,   1279,   1320,   1361,   1403,   1446,
    1489,   1532,   1576,   1620,   1664,   1709,   1754,   1800,
    1845,   1891,   1937,   1983,   2030,   2076,   2123,   2169,
    2216,   2262,   2309,   2355,   2402,   2448,   2494,   2540,
    2586,   2631,   2676,   2721,   2766,   2810,   2854,   2898,
    2941,   2984,   3026,   3067,   3109,   3149,   3189,   3229,
    3268,   3306,   3343,   3380,   3416,   3452,   3486,   3520,
    3553,   3585,   3617,   3647,   3677,   3706,   3733,   3760,
    3786,   3811,   3835,   3858,   3880,   3901,   3921,   3940,
    3958,   3975,   3991,   4006,   4019,   4032,   4043,   4053,
    4062,   4070,   4077,   4083,   4087,   4091,   4093,   4094,
    4094,   4093,   4091,   4087,   4083,   4077,   4070,   4062,
    4053,   4043,   4032,   4019,   4006,   3991,   3975,   3958,
    3940,   3921,   3901,   3880,   3858,   3835,   3811,   3786,
    3760,   3733,   3706,   3677,   3647,   3617,   3585,   3553,
    3520,   3486,   3452,   3416,   3380,   3343,   3306,   3268,
    3229,   3189,   3149,   3109,   3067,   3026,   2984,   2941,
    2898,   2854,   2810,   2766,   2721,   2676,   2631,   2586,
    2540,   2494,   2448,   2402,   2355,   2309,   2262,   2216,
    2169,   2123,   2076,   2030,   1983,   1937,   1891,   1845,
    1800,   1754,   1709,   1664,   1620,   1576,   1532,   1489,
    1446,   1403,   1361,   1320,   1279,   1239,   1199,   1160,
    1121,   1084,   1046,   1010,    974,    939,    905,    871,
    839,    807,    776,    746,    717,    689,    661,    635,
    609,    585,    561,    539,    517,    497,    477,    459,
    441,    425,    410,    396,    383,    371,    360,    350,
    342,    334,    328,    323,    319,    316,    314,    314,
};

static const int16_t dbTable[N_DB - 1] = {
    1,    1,    2,    2,    3,    4,    6,    8,
    10,   14,   18,   24,   33,   44,   59,   78,
    105,  140,  187,  250,  335,  448,  599,  801,
    1071, 1432, 1915, 2561, 3425, 4580, 6125
};

static inline void sum_dif(int16_t a, int16_t b, int16_t *s, int16_t *d)
{
    *s = a + b;
    *d = a - b;
}
static inline void mult_shf(int16_t cos, int16_t sin, int16_t x, int16_t y, int16_t *u, int16_t *v)
{
    *u = ((long)x * cos - (long)y * sin) >> 14;                             // !
    *v = ((long)y * cos + (long)x * sin) >> 14;                             // !
}

void fft_hamm_window(int16_t *fr)
{
    uint16_t i;
    for (i = 0; i < FFT_SIZE; i++) {
        fr[i] = fr[i] * hammingWindow[i] / 4096;
    }
}

void fft_rev_bin(int16_t *fr)
{
    int16_t m, mr = 0;
    int16_t tr, l;

    for (m = 1; m < FFT_SIZE; m++) {
        l = FFT_SIZE;
        do
            l >>= 1;
        while (mr + l >= FFT_SIZE);

        mr = (mr & (l - 1)) + l;

        if (mr <= m)
            continue;
        tr = fr[m];
        fr[m] = fr[mr];
        fr[mr] = tr;
    }
    return;
}

void fft_radix4(int16_t *fr, int16_t *fi)
{
    uint8_t ldm = 0, rdx = 2;
    uint16_t i0, i1, i2, i3;
    int16_t xr, yr, ur, vr, xi, yi, ui, vi, t;
    int16_t cos1, sin1, cos2, sin2, cos3, sin3;
    uint16_t m;
    uint8_t m4, phI0, phI;
    uint16_t r, i;

    for (i0 = 0; i0 < FFT_SIZE; i0 += 4) {
        i1 = i0 + 1;
        i2 = i1 + 1;
        i3 = i2 + 1;

        sum_dif(fr[i0], fr[i1], &xr, &ur);
        sum_dif(fr[i2], fr[i3], &yr, &vi);
        sum_dif(fi[i0], fi[i1], &xi, &ui);
        sum_dif(fi[i3], fi[i2], &yi, &vr);

        sum_dif(ui, vi, &fi[i1], &fi[i3]);
        sum_dif(xi, yi, &fi[i0], &fi[i2]);
        sum_dif(ur, vr, &fr[i1], &fr[i3]);
        sum_dif(xr, yr, &fr[i0], &fr[i2]);
    }

    for (ldm = 2 * rdx; ldm <= FFT_LOG2; ldm += rdx) {
        m = (1 << ldm);
        m4 = (m >> rdx);

        phI0 =  N_WAVE / m;
        phI  = 0;

        for (i = 0; i < m4; i++) {
            sin1 = sinTable[phI];
            sin2 = sinTable[2 * phI];
            sin3 = sinTable[3 * phI];

            cos1 = sinTable[phI + N_WAVE / 4];
            cos2 = sinTable[2 * phI + N_WAVE / 4];
            cos3 = sinTable[3 * phI + N_WAVE / 4];

            for (r = 0; r < FFT_SIZE; r += m) {
                i0 = i + r;
                i1 = i0 + m4;
                i2 = i1 + m4;
                i3 = i2 + m4;

                mult_shf(cos2, sin2, fr[i1], fi[i1], &xr, &xi);
                mult_shf(cos1, sin1, fr[i2], fi[i2], &yr, &vr);
                mult_shf(cos3, sin3, fr[i3], fi[i3], &vi, &yi);

                t = yi - vr;
                yi += vr;
                vr = t;

                ur = fr[i0] - xr;
                xr += fr[i0];

                sum_dif(ur, vr, &fr[i1], &fr[i3]);

                t = yr - vi;
                yr += vi;
                vi = t;

                ui = fi[i0] - xi;
                xi += fi[i0];

                sum_dif(ui, vi, &fi[i1], &fi[i3]);
                sum_dif(xr, yr, &fr[i0], &fr[i2]);
                sum_dif(xi, yi, &fi[i0], &fi[i2]);
            }
            phI += phI0;
        }
    }
    return;
}

void fft_cplx2dB(int16_t *fr, int16_t *fi)
{
    uint16_t i, j;
    int16_t calc;
    for (i = 0; i < FFT_SIZE / 2; i++) {
        calc = ((long)fr[i] * fr[i] + (long)fi[i] * fi[i]) >> 13;           // !

        for (j = 0; j < N_DB; j++)
            if (calc <= dbTable[j])
                break;
//        j = calc / 128;

        fr[i] = j;
    }
    return;
}
