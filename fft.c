#include "fft.h"

static const int16_t sinTable[N_WAVE / 2] = {
    0,      201,    402,    603,    804,    1005,   1206,   1406,
    1607,   1808,   2009,   2209,   2410,   2610,   2811,   3011,
    3211,   3411,   3611,   3811,   4011,   4210,   4409,   4608,
    4807,   5006,   5205,   5403,   5601,   5799,   5997,   6195,
    6392,   6589,   6786,   6982,   7179,   7375,   7571,   7766,
    7961,   8156,   8351,   8545,   8739,   8932,   9126,   9319,
    9511,   9703,   9895,   10087,  10278,  10469,  10659,  10849,
    11038,  11227,  11416,  11604,  11792,  11980,  12166,  12353,
    12539,  12724,  12909,  13094,  13278,  13462,  13645,  13827,
    14009,  14191,  14372,  14552,  14732,  14911,  15090,  15268,
    15446,  15623,  15799,  15975,  16150,  16325,  16499,  16672,
    16845,  17017,  17189,  17360,  17530,  17699,  17868,  18036,
    18204,  18371,  18537,  18702,  18867,  19031,  19194,  19357,
    19519,  19680,  19840,  20000,  20159,  20317,  20474,  20631,
    20787,  20942,  21096,  21249,  21402,  21554,  21705,  21855,
    22004,  22153,  22301,  22448,  22594,  22739,  22883,  23027,
    23169,  23311,  23452,  23592,  23731,  23869,  24006,  24143,
    24278,  24413,  24546,  24679,  24811,  24942,  25072,  25201,
    25329,  25456,  25582,  25707,  25831,  25954,  26077,  26198,
    26318,  26437,  26556,  26673,  26789,  26905,  27019,  27132,
    27244,  27355,  27466,  27575,  27683,  27790,  27896,  28001,
    28105,  28208,  28309,  28410,  28510,  28608,  28706,  28802,
    28897,  28992,  29085,  29177,  29268,  29358,  29446,  29534,
    29621,  29706,  29790,  29873,  29955,  30036,  30116,  30195,
    30272,  30349,  30424,  30498,  30571,  30643,  30713,  30783,
    30851,  30918,  30984,  31049,  31113,  31175,  31236,  31297,
    31356,  31413,  31470,  31525,  31580,  31633,  31684,  31735,
    31785,  31833,  31880,  31926,  31970,  32014,  32056,  32097,
    32137,  32176,  32213,  32249,  32284,  32318,  32350,  32382,
    32412,  32441,  32468,  32495,  32520,  32544,  32567,  32588,
    32609,  32628,  32646,  32662,  32678,  32692,  32705,  32717,
    32727,  32736,  32744,  32751,  32757,  32761,  32764,  32766,
    32767,  32766,  32764,  32761,  32757,  32751,  32744,  32736,
    32727,  32717,  32705,  32692,  32678,  32662,  32646,  32628,
    32609,  32588,  32567,  32544,  32520,  32495,  32468,  32441,
    32412,  32382,  32350,  32318,  32284,  32249,  32213,  32176,
    32137,  32097,  32056,  32014,  31970,  31926,  31880,  31833,
    31785,  31735,  31684,  31633,  31580,  31525,  31470,  31413,
    31356,  31297,  31236,  31175,  31113,  31049,  30984,  30918,
    30851,  30783,  30713,  30643,  30571,  30498,  30424,  30349,
    30272,  30195,  30116,  30036,  29955,  29873,  29790,  29706,
    29621,  29534,  29446,  29358,  29268,  29177,  29085,  28992,
    28897,  28802,  28706,  28608,  28510,  28410,  28309,  28208,
    28105,  28001,  27896,  27790,  27683,  27575,  27466,  27355,
    27244,  27132,  27019,  26905,  26789,  26673,  26556,  26437,
    26318,  26198,  26077,  25954,  25831,  25707,  25582,  25456,
    25329,  25201,  25072,  24942,  24811,  24679,  24546,  24413,
    24278,  24143,  24006,  23869,  23731,  23592,  23452,  23311,
    23169,  23027,  22883,  22739,  22594,  22448,  22301,  22153,
    22004,  21855,  21705,  21554,  21402,  21249,  21096,  20942,
    20787,  20631,  20474,  20317,  20159,  20000,  19840,  19680,
    19519,  19357,  19194,  19031,  18867,  18702,  18537,  18371,
    18204,  18036,  17868,  17699,  17530,  17360,  17189,  17017,
    16845,  16672,  16499,  16325,  16150,  15975,  15799,  15623,
    15446,  15268,  15090,  14911,  14732,  14552,  14372,  14191,
    14009,  13827,  13645,  13462,  13278,  13094,  12909,  12724,
    12539,  12353,  12166,  11980,  11792,  11604,  11416,  11227,
    11038,  10849,  10659,  10469,  10278,  10087,  9895,   9703,
    9511,   9319,   9126,   8932,   8739,   8545,   8351,   8156,
    7961,   7766,   7571,   7375,   7179,   6982,   6786,   6589,
    6392,   6195,   5997,   5799,   5601,   5403,   5205,   5006,
    4807,   4608,   4409,   4210,   4011,   3811,   3611,   3411,
    3211,   3011,   2811,   2610,   2410,   2209,   2009,   1808,
    1607,   1406,   1206,   1005,   804,    603,    402,    201,
};

static const uint16_t hammTable[N_HANN / 2] = {
    5027,   5028,   5030,   5032,   5036,   5042,   5048,   5055,
    5064,   5074,   5084,   5096,   5109,   5124,   5139,   5156,
    5173,   5192,   5212,   5233,   5255,   5279,   5303,   5329,
    5355,   5383,   5412,   5442,   5474,   5506,   5539,   5574,
    5610,   5647,   5685,   5724,   5764,   5805,   5848,   5891,
    5936,   5982,   6028,   6076,   6125,   6176,   6227,   6279,
    6333,   6387,   6443,   6499,   6557,   6616,   6676,   6737,
    6799,   6862,   6927,   6992,   7058,   7126,   7194,   7264,
    7335,   7406,   7479,   7553,   7628,   7704,   7781,   7859,
    7938,   8018,   8099,   8181,   8264,   8348,   8433,   8519,
    8606,   8695,   8784,   8874,   8965,   9057,   9151,   9245,
    9340,   9436,   9533,   9631,   9730,   9830,   9931,   10033,
    10136,  10239,  10344,  10450,  10557,  10664,  10773,  10882,
    10992,  11104,  11216,  11329,  11443,  11558,  11673,  11790,
    11907,  12026,  12145,  12265,  12386,  12508,  12631,  12755,
    12879,  13004,  13131,  13258,  13385,  13514,  13643,  13774,
    13905,  14037,  14169,  14303,  14437,  14572,  14708,  14845,
    14982,  15120,  15259,  15399,  15539,  15681,  15822,  15965,
    16108,  16253,  16397,  16543,  16689,  16836,  16984,  17132,
    17281,  17431,  17581,  17732,  17884,  18036,  18189,  18343,
    18497,  18652,  18808,  18964,  19120,  19278,  19436,  19594,
    19754,  19913,  20074,  20235,  20396,  20558,  20721,  20884,
    21048,  21212,  21377,  21542,  21708,  21874,  22041,  22208,
    22376,  22544,  22713,  22882,  23052,  23222,  23393,  23564,
    23736,  23908,  24080,  24253,  24426,  24600,  24774,  24948,
    25123,  25298,  25474,  25650,  25826,  26003,  26180,  26357,
    26535,  26713,  26891,  27070,  27249,  27428,  27608,  27788,
    27968,  28148,  28329,  28510,  28691,  28873,  29054,  29236,
    29419,  29601,  29784,  29966,  30149,  30333,  30516,  30700,
    30883,  31067,  31251,  31436,  31620,  31805,  31989,  32174,
    32359,  32544,  32729,  32914,  33099,  33285,  33470,  33656,
    33841,  34027,  34213,  34398,  34584,  34770,  34956,  35142,
    35327,  35513,  35699,  35885,  36071,  36256,  36442,  36628,
    36813,  36999,  37184,  37370,  37555,  37740,  37925,  38110,
    38295,  38480,  38665,  38850,  39034,  39218,  39402,  39586,
    39770,  39954,  40137,  40321,  40504,  40687,  40870,  41052,
    41234,  41416,  41598,  41780,  41961,  42142,  42323,  42504,
    42684,  42864,  43044,  43223,  43402,  43581,  43760,  43938,
    44116,  44293,  44471,  44647,  44824,  45000,  45176,  45351,
    45526,  45701,  45875,  46049,  46223,  46396,  46568,  46740,
    46912,  47083,  47254,  47425,  47595,  47764,  47933,  48102,
    48270,  48437,  48604,  48771,  48937,  49103,  49268,  49432,
    49596,  49760,  49922,  50085,  50247,  50408,  50568,  50728,
    50888,  51047,  51205,  51363,  51520,  51676,  51832,  51987,
    52142,  52296,  52449,  52602,  52754,  52905,  53056,  53206,
    53355,  53504,  53652,  53799,  53946,  54092,  54237,  54381,
    54525,  54668,  54810,  54952,  55093,  55233,  55372,  55511,
    55648,  55785,  55922,  56057,  56192,  56326,  56459,  56591,
    56723,  56853,  56983,  57112,  57240,  57368,  57494,  57620,
    57745,  57869,  57992,  58115,  58236,  58357,  58476,  58595,
    58713,  58830,  58947,  59062,  59176,  59290,  59402,  59514,
    59625,  59735,  59844,  59952,  60059,  60165,  60270,  60374,
    60478,  60580,  60682,  60782,  60881,  60980,  61078,  61174,
    61270,  61364,  61458,  61551,  61642,  61733,  61823,  61911,
    61999,  62086,  62171,  62256,  62340,  62422,  62504,  62584,
    62664,  62742,  62820,  62896,  62972,  63046,  63119,  63191,
    63263,  63333,  63402,  63470,  63537,  63603,  63667,  63731,
    63794,  63855,  63916,  63975,  64034,  64091,  64147,  64202,
    64256,  64309,  64361,  64412,  64461,  64510,  64557,  64603,
    64649,  64693,  64736,  64777,  64818,  64858,  64896,  64934,
    64970,  65005,  65039,  65072,  65104,  65135,  65164,  65193,
    65220,  65246,  65271,  65295,  65318,  65339,  65360,  65379,
    65398,  65415,  65431,  65445,  65459,  65472,  65483,  65493,
    65502,  65510,  65517,  65523,  65528,  65531,  65533,  65534,
};

static const uint16_t dbTable[N_DB] = {
    1,     2,     3,     4,     5,     6,     7,     8,
    9,     10,    11,    12,    13,    14,    16,    17,
    18,    20,    21,    23,    24,    26,    27,    29,
    31,    33,    35,    36,    38,    40,    42,    45,
    47,    49,    51,    54,    56,    59,    62,    64,
    67,    70,    73,    76,    79,    83,    86,    90,
    93,    97,    101,   105,   109,   113,   117,   122,
    126,   131,   136,   141,   146,   152,   157,   163,
    169,   175,   181,   187,   194,   201,   208,   215,
    223,   230,   238,   246,   255,   264,   273,   282,
    291,   301,   311,   322,   333,   344,   355,   367,
    379,   392,   405,   418,   432,   446,   460,   476,
    491,   507,   524,   541,   558,   576,   595,   614,
    634,   654,   675,   697,   720,   743,   766,   791,
    816,   842,   869,   897,   925,   955,   985,   1017,
    1049,  1082,  1116,  1152,  1188,  1226,  1264,  1304,
    1345,  1388,  1432,  1477,  1523,  1571,  1621,  1671,
    1724,  1778,  1834,  1891,  1951,  2012,  2075,  2140,
    2207,  2276,  2347,  2420,  2496,  2574,  2654,  2737,
    2823,  2911,  3002,  3095,  3192,  3291,  3394,  3500,
    3609,  3721,  3837,  3956,  4080,  4207,  4337,  4472,
    4611,  4755,  4903,  5055,  5212,  5374,  5541,  5713,
    5891,  6073,  6262,  6456,  6657,  6863,  7076,  7296,
    7522,  7756,  7996,  8244,  8500,  8764,  9035,  9316,
    9604,  9902,  10209, 10525, 10852, 11188, 11535, 11892,
    12260, 12640, 13032, 13435, 13852, 14281, 14723, 15179,
    15649, 16133, 16633, 17148, 17679, 18226, 18791, 19372,
    19972, 20590, 21227, 21884, 22562, 23260, 23980, 24722,
    25487, 26276, 27089, 27927, 28791, 29682, 30600, 31547,
    32523, 33529, 34567, 35636, 36738, 37875, 39047, 40254,
    41500, 42783, 44107, 45471, 46877, 48327, 49822, 51363,
    52952, 54589, 56278, 58018, 59812, 61662, 63569, 65535,
};

static inline uint8_t fft_getDb(uint16_t value, uint8_t min, uint8_t max)
{
    uint8_t mid = (min + max) / 2;

    if (dbTable[mid] < value) {
        return mid == min ? mid : fft_getDb(value, mid, max);
    } else {
        return mid == max ? mid : fft_getDb(value, min, mid);
    }
}

static inline int16_t sinTbl(int16_t phi)
{
    return sinTable[phi & (N_WAVE / 2 - 1)] * (phi < N_WAVE / 2 ? 1 : -1);
}

static inline void sum_dif(int16_t a, int16_t b,
                           int16_t *s, int16_t *d)
{
    *s = a + b;
    *d = a - b;
}

static inline void mult_shf(int16_t cos, int16_t sin, int16_t x, int16_t y,
                            int16_t *u, int16_t *v)
{
    *u = ((int32_t)x * cos - (int32_t)y * sin) >> 15;
    *v = ((int32_t)y * cos + (int32_t)x * sin) >> 15;
}

int16_t fft_sin(int16_t phi)
{
    return sinTbl(phi % N_WAVE);
}

int16_t fft_cos(int16_t phi)
{
    return sinTbl((phi + N_WAVE / 4) % N_WAVE);
}

void fft_hamm_window(int16_t *fr)
{
    for (int16_t i = 0; i < FFT_SIZE / 2; i++) {
        uint32_t ht = hammTable[i * (N_HANN / FFT_SIZE)];
        fr[i] = (ht * fr[i]) >> 16;
        fr[FFT_SIZE - 1 - i] = (ht * fr[FFT_SIZE - 1 - i]) >> 16;
    }
}

void fft_rev_bin(int16_t *fr)
{
    int16_t m, mr = 0;
    int16_t tr, l;

    for (m = 1; m < FFT_SIZE; m++) {
        l = FFT_SIZE;
        do {
            l >>= 1;
        } while (mr + l >= FFT_SIZE);

        mr = (mr & (l - 1)) + l;

        if (mr <= m) {
            continue;
        }
        tr = fr[m];
        fr[m] = fr[mr];
        fr[mr] = tr;
    }
}

void fft_radix4(int16_t *fr, int16_t *fi)
{
    int16_t ldm = 0, rdx = 2;

    for (int16_t i0 = 0; i0 < FFT_SIZE; i0 += 4) {
        int16_t i1 = i0 + 1;
        int16_t i2 = i1 + 1;
        int16_t i3 = i2 + 1;

        int16_t xr, yr, ur, vr, xi, yi, ui, vi;

        sum_dif(fr[i0], fr[i1], &xr, &ur);
        sum_dif(fr[i2], fr[i3], &yr, &vi);
        sum_dif(fi[i0], fi[i1], &xi, &ui);
        sum_dif(fi[i3], fi[i2], &yi, &vr);

        sum_dif(ui, vi, &fi[i1], &fi[i3]);
        sum_dif(xi, yi, &fi[i0], &fi[i2]);
        sum_dif(ur, vr, &fr[i1], &fr[i3]);
        sum_dif(xr, yr, &fr[i0], &fr[i2]);
    }

    for (ldm = 2 * rdx; ldm <= FFT_LOG2; ldm += rdx) {
        int16_t m = (1 << ldm);
        int16_t m4 = (m >> rdx);

        int16_t phi0 =  N_WAVE / m;
        int16_t phi  = 0;

        for (int16_t i = 0; i < m4; i++) {
            int16_t sin1, sin2, sin3;
            int16_t cos1, cos2, cos3;

            sin1 = sinTbl(1 * phi);
            sin2 = sinTbl(2 * phi);
            sin3 = sinTbl(3 * phi);

            cos1 = sinTbl(1 * phi + N_WAVE / 4);
            cos2 = sinTbl(2 * phi + N_WAVE / 4);
            cos3 = sinTbl(3 * phi + N_WAVE / 4);

            for (int16_t r = 0; r < FFT_SIZE; r += m) {
                int16_t i0 = i + r;
                int16_t i1 = i0 + m4;
                int16_t i2 = i1 + m4;
                int16_t i3 = i2 + m4;

                int16_t xr, yr, ur, vr, xi, yi, ui, vi;
                int16_t t;

                mult_shf(cos2, sin2, fr[i1], fi[i1], &xr, &xi);
                mult_shf(cos1, sin1, fr[i2], fi[i2], &yr, &vr);
                mult_shf(cos3, sin3, fr[i3], fi[i3], &vi, &yi);

                t = yi - vr;
                yi += vr;
                vr = t;

                ur = fr[i0] - xr;
                xr += fr[i0];

                sum_dif(ur, vr, &fr[i1], &fr[i3]);

                t = yr - vi;
                yr += vi;
                vi = t;

                ui = fi[i0] - xi;
                xi += fi[i0];

                sum_dif(ui, vi, &fi[i1], &fi[i3]);
                sum_dif(xr, yr, &fr[i0], &fr[i2]);
                sum_dif(xi, yi, &fi[i0], &fi[i2]);
            }
            phi += phi0;
        }
    }
}

void fft_cplx2dB(int16_t *fr, int16_t *fi, uint8_t *out)
{
    int16_t i, j;
    uint16_t accum = 0;

    for (i = 0, j = 0; i < FFT_SIZE / 2; i++) {
        uint16_t calc = (fr[i] * fr[i] + fi[i] * fi[i]) >> 16;
        accum += fft_getDb(calc, 0, N_DB - 1);

        if (i < 40) {
            out[j++] = (uint8_t)(accum / 1);
            accum = 0;
        } else if (i < 80) {
            if ((i & 0x01) == 0x01) {
                out[j++] = (uint8_t)(accum / 2);
                accum = 0;
            }
        } else if (i < 160) {
            if ((i & 0x03) == 0x03) {
                out[j++] = (uint8_t)(accum / 4);
                accum = 0;
            }
        } else if (i < 320) {
            if ((i & 0x07) == 0x07) {
                out[j++] = (uint8_t)(accum / 8);
                accum = 0;
            }
        } else {
            if ((i & 0x0F) == 0x0F) {
                out[j++] = (uint8_t)(accum / 16);
                accum = 0;
            }
        }
    }
}
